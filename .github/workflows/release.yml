name: Build & Release Captioneer

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "number=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Update app version in project
        run: |
          sed -i '' "s/MARKETING_VERSION = .*;/MARKETING_VERSION = ${{ steps.version.outputs.number }};/g" CaptioneerStandalone/Captioneer.xcodeproj/project.pbxproj

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CaptioneerStandalone/Captioneer.xcodeproj/project.pbxproj
          git commit -m "Bump version to ${{ steps.version.outputs.number }}" || echo "No changes to commit"
          git push origin HEAD:refs/heads/master || echo "Push skipped"

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Build universal app + DMG
        working-directory: CaptioneerStandalone
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Upload DMG to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: CaptioneerStandalone/build/release/Captioneer.dmg
          name: Captioneer ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation

            ### Homebrew

            ```bash
            brew tap radioheavy/captioneer
            brew install --cask captioneer
            ```

            ### Manual

            1. Download **Captioneer.dmg**
            2. Open and drag **Captioneer.app** to Applications
            3. If macOS blocks first launch, run:

            ```bash
            xattr -cr /Applications/Captioneer.app
            ```
